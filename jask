#! /usr/bin/env v8cgi

/*
Jask: Javascript Tasks
	Simple JS Tasks using V8CGI.

License:
	MIT-Style License (See included README file for details).

Copyright:
	Copyright 2009 Mark Obcena, <http://keetology.com>
*/

// Add compat for older v8cgi versions.
if (System && !system) system = System;

var console = {
	log: function(){
		system.stdout.apply(this, arguments);
	},

	dir: function(){
		console.log(JSON.stringify.apply(this, arguments));
	}
};

try {

	include('getopt');

	var Jask = {

		Tasks: {},
		Args: [],
		Descs: {},

		cwd: system.getcwd() + "/",

		initialize: function(){
			Jask.Tasks = this.Tasks;
			var opts = new GetOpt();
			opts.add('taskfile', 'The tasksfile to use.', 'taskfile', 't', 'taskfile', GetOpt.REQUIRED_ARGUMENT);
			opts.add('list', 'List all available tasks.', false, 'l', 'list', GetOpt.NO_ARGUMENT);
			opts.add('help', 'Show help text.', false, 'h', 'help', GetOpt.NO_ARGUMENT);

			if (arguments.length > 1) {
				opts.parse(arguments);
				var taskfile = new File(this.cwd + opts.get('taskfile'));
				if (!taskfile.isFile()) {
					console.log('\nNo taskfile found! Use --help for more details.\n');
					return null;
				} else {
					this.parseTasksFile(taskfile.toString());
					if (opts.get('list')) return this.listTasks();
					if (opts.get('help')) return this.help();
					var task_args = opts.get();
					if (task_args.length !== 0) {
						var metargs = task_args.shift().split(':');
						var nspace = metargs[0];
						var action = metargs[1];
						if (action.charAt(0) !== '_' && this.Tasks[nspace] && this.Tasks[nspace][action]) {
							Jask.Args = task_args;
							this.Tasks[nspace][action].apply(this.Tasks[nspace], task_args);
							return null;
						} else {
							console.log('\nNo such task! Use --help for more details or --list to see available tasks.\n');
							return null;
						}
					}
				}
			}
			return this.help();
		},

		parseTasksFile: function(taskfile){
				taskfile = include(taskfile);
				for (var namespace in taskfile) {
					var tasklist = this.Tasks[namespace] = {};
					for (var item in taskfile[namespace]) {
						if (item == 'Include') {
							var includes = taskfile[namespace][item];
							for (var x = 0, y = includes.length; x < y; x++) {
								this.parseTasksFile(this.cwd + includes[x]);
							}
						} else if (item == 'Desc') {
							this.Descs[namespace] = taskfile[namespace][item];
						} else {
							this.parseTask(item, namespace, taskfile[namespace][item]);
						}
					}
				};
		},

		parseTask: function(item, nspace, func){
			var parseName = item.match(/([\d\D]+)[\s]([>|<])[\s]([\d\D]+)/);
			if (parseName) {
				item = parseName[1];
				var condition = parseName[2];
				var p = parseName[3].split(':');
				var oitem = (p.length == 1) ? p[0] : p[1];
				var onspa = (p.length > 1) ? p[0] : nspace;
				var funn = null;
				if (condition == '<') {
					funn = function(){
						Jask.Tasks[onspa][oitem].apply(Jask.Tasks[onspa], arguments);
						func.apply(Jask.Tasks[nspace], arguments);
					};
				} else {
					funn = function(){
						func.apply(Jask.Tasks[nspace], arguments);
						Jask.Tasks[onspa][oitem].apply(Jask.Tasks[onspa], arguments);
					};
				}
			}
			this.Tasks[nspace][item] = funn || func;
		},

		listTasks: function(){
			var buff = "\nAvailable Tasks:\n\n";
			for (var ns in this.Descs) {
				for (var item in this.Descs[ns]) {
					var itemargs = this.Descs[ns][item][1] || "";
					var itemdesc = this.Descs[ns][item][0];
					buff += "  " + ns + ":" + item + " "  + itemargs + "\t" + itemdesc + "\n";
				}
			}
			console.log(buff);
			return null;
		},

		help: function(){
			var buff = "JASK: Javascript Tasks\nUsage:\n";
			buff += "  $ jask [-t=taskfile] namespace:task args\n";
			buff += "  $ jask -l\n\nOptions:\n";
			buff += "  -t=file,\t\tSet taskfile.\n  --taskfile=file\n";
			buff += "  -l, --list\t\tList available tasks\n";
			buff += "  -h, --help\t\tShow this help text.\n";
			console.log(buff);
			return null;
		}

	}

	Jask.Args = [];
	Jask.Tasks = {};

	system.args.shift();
	Jask.initialize(system.args);

} catch(e) {
	console.log(e);
}